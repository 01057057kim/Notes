<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteNest</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css">
</head>
<body>
    <main>
        <div class="container">
            <div class="container-account">
                <h1 class="container-account-logo signOut">NoteNest</h1>
                <div class="container-account-div">
                    <label class="container-account-label" id="usernameLabel"></label>
                    <button class="container-account-button signOut" id="signOut">Sign Out</button>
                </div>
            </div>
            <div class="container-category">
                <div class="container-category-labbut">
                    <label><b>Category</b></label>
                    <button class="container-category-button" id="newCategory"> +</button>
                </div>
                <div class="container-category-div">
                    <section id="posts">
                    </section>
                </div>
            </div>
        </div>
        <section id="notePosts">
        </section>

    </main>
</body>
<script>
    const signOutElements = document.querySelectorAll('.signOut');
    signOutElements.forEach(function(element) {
        element.addEventListener('click', async function() {
            try{
                const response = await fetch('http://localhost:3000/account/signout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                alert(data.message);
                
                if(data.success){
                    localStorage.clear();
                    window.location.replace('/index.html');
                }
            } catch (error) {
                console.log('Error:', error);
            }
        })
    })

    async function getUsername(){
        try{
           const response = await fetch('/account/getusername')
           const data = await response.json()
           
           if(data.success){
                document.getElementById('usernameLabel').innerHTML = `Welcome <em><b>${data.username}</b></em>`
           }else{
            console.log('Username Invalid', error);
           }
           
        }catch(error){
            console.log('Username Invalid', error);
        }
    }
    
    document.getElementById('newCategory').addEventListener('click', async function(){
        const categoryName = 'input here';
        try{
            
            const response = await fetch('http://localhost:3000/category/createcategory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    categoryName
                })
            });

            const data = await response.json();

            alert(data.message);
            
            if(data.success){
                console.log('Category created');
                location.reload();
            }
        } catch (error) {
            console.log('Error create category', error);
        }
    });

    async function getCategory() {
        try{
            const response = await fetch('/category/getcategory', {credentials: 'include'})
            const data = await response.json();
            const postSection = document.getElementById('posts')
            postSection.innerHTML = ''
            document.getElementById('notePosts').innerHTML = ''
            if (!data.success){
                console.log('Error', data.message)
                return
            }

            data.categories.forEach(function(category) {
                const categoryElement = document.createElement('section')
                categoryElement.innerHTML = `
                <textarea class="updateLiveCategoryName" data-category-id="${category._id}">${category.categoryName}</textarea>
                <button onClick="deleteCategory('${category._id}')">Delete</button> </br>
                <div class="addNote">
                    <button class="addNotesButton" data-category-id="${category._id}" >Add Notes</button>
                    <div class="addNote-popup">
                        <label>Title<label>
                        <input class="notesTitle" type="text"></br>
                        <label>Content<label>
                        <textarea class='notesContent'></textarea>   
                    </div>
                </div>
                <section id="notes-${category._id}"></section>
                `
                postSection.appendChild(categoryElement)

                const textarea = categoryElement.querySelector('.updateLiveCategoryName');
                    textarea.addEventListener('input', (event) => {
                        const newValue = event.target.value;
                        const categoryId = event.target.dataset.categoryId;
                        updateCategory(categoryId, newValue);
                    });

                getNotes(category._id)
            });

        }catch(err){
            console.log(err)
        }
    }

    async function deleteCategory(id) {
        try{
            const response = await fetch('/category/deletecategory',{
                method: 'DELETE',
                headers: {'Content-Type':'application/json'},
                credentials: "include",
                body: JSON.stringify({id})
            })
            const data = await response.json()
            if(data.success){
                alert('Succes Delete Category')
                location.reload()
            }else{
                alert('Failed to delete')
                console.log(err)
            }
        }catch(err){
            console.log('Error:', err)
        }
    }

    //add note button using classList that contains addNotesButton
    document.addEventListener('click', async function (event) {
        if (event.target.classList.contains('addNotesButton')) { 
            const categoryId = event.target.dataset.categoryId
            const title = event.target.closest('section').querySelector('.notesTitle').value;
            const content = event.target.closest('section').querySelector('.notesContent').value;

            if (!title || !content) {
                alert("Please fill in both Title and Content");
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/notes/createnotes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        title, 
                        content, 
                        categoryId })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Note added successfully!');
                    getNotes(categoryId);
                   
                } else {
                    alert('Failed to add note: ' + data.message);
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }
    });

    async function getNotes(categoryId) {
        try{
            const response = await fetch(`/notes/getnotes?categoryId=${categoryId}`, { credentials: 'include' })  // get query of categoryId on database category
            const data = await response.json()
            const postSection = document.getElementById(`notes-${categoryId}`)

            if(postSection){
                postSection.innerHTML = ''
            }
            if (!data.success){
                console.log('Error', data.message)
                return
            }
            if(data.notes.length == 0 ){ //check if there any note
                if(postSection){
                    postSection.innerHTML = 'No Note added'
                }
                return
            }
        
            data.notes.forEach(function(notes) {
                const notesElement = document.createElement('section')
                notesElement.innerHTML = `
                <div>
                    <textarea class="updateLiveTitle" data-category-id="${notes._id}">${notes.title}</textarea> </br>
                    <textarea class="updateLiveContent" data-category-id="${notes._id}">${notes.content}</textarea>
                    <button onClick="deleteNotes('${notes._id}')">Delete notes</button> 
                </div>
                `
                if(postSection){    
                    postSection.appendChild(notesElement)
                    
                    const titleTextarea = notesElement.querySelector('.updateLiveTitle');
                    const contentTextarea = notesElement.querySelector('.updateLiveContent');
                    
                    titleTextarea.addEventListener('input', (event) => {
                        const newValue = event.target.value;
                        const noteId = event.target.dataset.noteId;
                        updateNotesTitle(noteId, newValue);
                    });
                    contentTextarea.addEventListener('input', (event) => {
                        const newValue = event.target.value;
                        const noteId = event.target.dataset.noteId;
                        updateNotesContent(noteId, newValue);
                    });
                }
            });
            if(data.success){
                console.log("Success get note data")
            }else{
                console.log("Error get notes data")
            }
        }catch(err){
            console.log("Error: ", err)
        }
    }
    
    async function deleteNotes(noteId) {
        try{
            const response = await fetch('/notes/deletenotes',{
                method: 'DELETE',
                headers: {'Content-Type':'application/json'},
                credentials: "include",
                body: JSON.stringify({noteId})
            })
            const data = await response.json()
            if(data.success){
                alert('Succes Delete notes')
                getCategory();
            }else{
                alert('Failed to delete')
                console.log(err)
            }
        }catch(err){
            console.log('Error:', err)
        }
    }
    
    async function updateCategory(categoryId, newValue) {
        try {
            const response = await fetch('/category/updatecategory', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categoryId, newValue })
            });
            const data = await response.json();
            if (data.success) {
                console.log('Category updated successfully');
            } else {
                console.log('Failed to update category:', data.message);
            }
        } catch (err) {
            console.log('Update category failed:', err);
        }
    }

    async function updateNotesTitle(noteId, newValue) {
        try {
            const response = await fetch('/notes/updatenotes', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ noteId, newTitle: newValue })
            });
            const data = await response.json();
            if (data.success) {
                console.log('Note title updated successfully');
            } else {
                console.log('Failed to update note title:', data.message);
            }
        } catch (err) {
            console.log('Update note title failed:', err);
        }
    }

    async function updateNotesContent(noteId, newValue) {
        try {
            const response = await fetch('/notes/updatenotes', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ noteId, newContent: newValue })
            });
            const data = await response.json();
            if (data.success) {
                console.log('Note content updated successfully');
            } else {
                console.log('Failed to update note content:', data.message);
            }
        } catch (err) {
            console.log('Update note content failed:', err);
        }
    }

    window.onload = function(){
        getUsername()
        getCategory()
    }


</script>
</html>